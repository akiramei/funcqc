# funcqc Database Migration System (PoC)

このディレクトリには、funcqc用のデータベースマイグレーションシステムのProof of Concept（PoC）実装が含まれています。

## 📋 PoC の目的

現在のfuncqcは、スキーマ変更時に`dropOldTablesIfNeeded()`で全データを削除する破壊的な方式を採用しています。このPoCは、データ保全しながらスキーマを進化させる仕組みの実現可能性を検証します。

## 🏗️ アーキテクチャ

### シンプルマイグレーション方式の採用

当初はKyselyとの完全統合を検討しましたが、PGLiteとの統合に技術的複雑さがあったため、PoCではよりシンプルなアプローチを採用：

- **PGLite生機能を使用**: `db.exec()`と`db.query()`でSQL直接実行
- **funcqc_migrations テーブル**: 独自のマイグレーション履歴管理
- **データ保全**: OLD_プレフィックスでのテーブルバックアップ
- **トランザクション制御**: マイグレーション失敗時の自動ロールバック

## 📁 ファイル構成

```
src/migrations/
├── README.md                          # このファイル
├── simple-migration-manager.ts        # ✅ メインのマイグレーション管理
├── helpers.ts                         # ⚠️ データ保全ヘルパー（Kysely用、参考実装）
├── 001_initial_schema.ts             # ⚠️ 初回マイグレーション（Kysely用、参考実装）
└── migration-manager.ts              # ⚠️ Kysely統合版（PoC段階では未完成）

test/migrations/
├── simple-migration-manager.test.ts   # ✅ メイン機能のテスト（8/12テストパス）
└── migration-manager.test.ts          # ⚠️ Kysely版テスト（参考実装）
```

## 🚀 実装された機能

### ✅ 動作確認済み

1. **基本マイグレーション管理**
   - マイグレーション履歴テーブルの自動作成
   - 適用済みマイグレーション一覧の取得
   - 重複実行の防止

2. **カスタムマイグレーション実行**
   - SQL文配列の順次実行
   - トランザクション制御（失敗時自動ロールバック）
   - 実行時間とチェックサムの記録

3. **エラーハンドリング**
   - SQL構文エラーの適切な処理
   - ロールバック機能
   - エラーメッセージの詳細出力

4. **開発サポート機能**
   - マイグレーション履歴のリセット
   - バックアップテーブル一覧
   - 古いバックアップのクリーンアップ

### ⚠️ 部分実装（改良が必要）

1. **テーブルマイグレーション**
   - 基本的なロジックは実装済み
   - データ移行SQLの動的生成で課題あり
   - バックアップテーブル名の一意性で問題

2. **初回マイグレーション**
   - database.sqlの読み込みロジック実装済み
   - ファイルパス解決で課題あり

## 🧪 テスト結果

```bash
npm run test test/migrations/simple-migration-manager.test.ts
```

**結果**: 12テスト中8テストパス（67%成功率）

- ✅ **基本機能**: 全てパス
- ✅ **カスタムマイグレーション**: 全てパス  
- ✅ **開発ユーティリティ**: 全てパス
- ⚠️ **テーブルマイグレーション**: 改良が必要
- ⚠️ **バックアップ管理**: 一部改良が必要

## 💡 PoC から得られた知見

### 技術的実現可能性

1. **PGLite統合**: ✅ 基本的なマイグレーション管理は十分実現可能
2. **データ保全**: ✅ OLD_テーブルによるバックアップは動作
3. **トランザクション制御**: ✅ エラー時の自動ロールバック機能
4. **性能**: ✅ 小規模データで良好なパフォーマンス

### 技術的課題

1. **Kysely統合の複雑性**: PGLiteとKyselyの直接統合は想定以上に複雑
2. **動的SQL生成**: 複雑なスキーマ変更の自動SQL生成は課題
3. **ファイルパス管理**: テスト環境と本番環境のパス解決

### 推奨する実装方針

PoCの結果を踏まえ、以下の段階的アプローチを推奨：

#### Phase 2A: シンプル実装の完成（推奨）
- SimpleMigrationManagerをベースとした実装
- 手動マイグレーションファイル作成
- PGLiteAdapterとの統合
- 基本的なCLIコマンド

#### Phase 2B: 高度機能の追加（将来）
- 自動マイグレーションSQL生成
- Kyselyとの完全統合
- 複雑なスキーマ変更サポート

## 🎯 次のステップ

1. **チームレビュー**: このPoCの技術方針についてチーム合意
2. **実装方針決定**: シンプル実装 vs 高度実装の選択
3. **Phase 2実装**: 合意された方針での本格実装
4. **PGLiteAdapter統合**: 既存システムとの統合
5. **CLI統合**: 使いやすいコマンドラインインターフェース

## 📚 参考実装

- `helpers.ts`: データ保全機能の詳細実装（Kysely版）
- `migration-manager.ts`: Kysely完全統合版の試行錯誤
- `001_initial_schema.ts`: database.sqlベースの初回マイグレーション例

これらのファイルは、将来の高度実装時の参考として保持しています。

---

**PoCの結論**: funcqcのマイグレーション機能は技術的に実現可能。シンプルな実装でも十分な価値を提供できる。